{% extends "base/base.html" %}
{% load static %}
{% load workout_tags %}

{% block title %}День {{ day.day_number }} - AI Fitness Coach{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <!-- Header -->
            <div class="text-center mb-5">
                <div class="day-number-large mb-3">{{ day.day_number }}</div>
                <h1 class="display-5 mb-3">{{ day.name }}</h1>
                
                {% if day.is_rest_day %}
                    <div class="alert alert-info">
                        <i class="fas fa-bed fa-2x mb-3"></i>
                        <h4>Сегодня день отдыха</h4>
                        <p class="mb-0">Дайте своему телу время на восстановление. Можете прогуляться или сделать легкую растяжку.</p>
                    </div>
                {% else %}
                    <p class="lead text-muted">
                        {{ exercises|length }} {{ exercises|length|exercise_count_plural }} для достижения ваших целей
                    </p>
                {% endif %}
            </div>

            {% comment %} Современный видео-плеер с плейлистом {% endcomment %}
            {% if playlist %}
              <div class="modern-video-container">
                <div class="row">
                  <div class="col-xl-9 col-lg-8">
                    <!-- Современный видео-плеер -->
                    <div class="modern-video-player">
                      <!-- Инфо о текущем видео (над плеером) -->
                      <div class="video-info-header" id="videoInfoHeader" style="display: none;">
                        <div class="video-current-info">
                          <h4 class="current-video-title" id="currentVideoTitleHeader">{{ playlist.0.video.name }}</h4>
                          <div class="video-progress-indicator">
                            <span class="progress-text">
                              Видео <span id="currentVideoNumber">1</span> из {{ playlist|length }}
                            </span>
                            <div class="mini-progress-bar">
                              <div class="mini-progress-fill" id="miniProgressFill"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="video-container-modern">
                        <!-- Start overlay -->
                        <div id="startOverlay" class="modern-start-overlay">
                          <div class="start-content">
                            <div class="start-icon-wrapper">
                              <div class="start-icon-bg"></div>
                              <i class="fas fa-play start-icon"></i>
                            </div>
                            <h3 class="start-title">Начать тренировку</h3>
                            <p class="start-subtitle">{{ playlist|length }} видео ждут вас</p>
                            <button class="modern-start-btn" onclick="startPlaylist()">
                              <span>Начать</span>
                              <i class="fas fa-arrow-right"></i>
                            </button>
                          </div>
                        </div>
                        
                        <!-- Видео-плеер без перекрывающих элементов -->
                        <video 
                          id="mainVideoPlayer"
                          class="clean-video-player"
                          controls 
                          preload="metadata"
                          playsinline>
                          <source src="{{ playlist.0.video.r2_url }}" type="video/mp4">
                          Ваш браузер не поддерживает видео.
                        </video>
                      </div>
                      
                      <!-- Контролы под плеером -->
                      <div class="modern-controls" id="modernControls" style="display: none;">
                        <div class="controls-wrapper">
                          <button class="modern-control-btn" onclick="previousVideo()" title="Предыдущее">
                            <i class="fas fa-step-backward"></i>
                          </button>
                          <button class="modern-control-btn play-pause-btn" onclick="togglePlayPause()" id="modernPlayPauseBtn" title="Пауза">
                            <i class="fas fa-pause"></i>
                          </button>
                          <button class="modern-control-btn" onclick="nextVideo()" title="Следующее">
                            <i class="fas fa-step-forward"></i>
                          </button>
                        </div>
                        <div class="playlist-progress">
                          <div class="progress-track">
                            <div class="progress-fill" id="playlistProgressBar"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-xl-3 col-lg-4">
                    <!-- Плейлист сбоку -->
                    <div class="playlist-sidebar">
                      <div class="playlist-sidebar-header">
                        <h5><i class="fas fa-list"></i> Плейлист тренировки</h5>
                        <span class="playlist-count">{{ playlist|length }} видео</span>
                      </div>
                      
                      <div class="playlist-items">
                        {% for it in playlist %}
                          <div class="playlist-sidebar-item {% if forloop.first %}active{% endif %}"
                               data-index="{{ forloop.counter0 }}"
                               data-video-url="{{ it.video.r2_url }}"
                               data-video-title="{{ it.video.name }}"
                               data-video-role="{{ it.role }}"
                               onclick="jumpToVideo({{ forloop.counter0 }})">
                            <div class="item-number">{{ forloop.counter }}</div>
                            <div class="item-content">
                              <div class="item-title">{{ it.video.name }}</div>
                              <div class="item-meta">
                                <span class="item-role {{ it.role|lower }}">{{ it.role|title }}</span>
                                {% if it.duration_seconds %}
                                  <span class="item-duration">{{ it.duration_seconds }}с</span>
                                {% endif %}
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Статистика плейлиста -->
              <div class="playlist-summary mt-4">
                <div class="row text-center">
                  <div class="col-4">
                    <div class="summary-stat">
                      <i class="fas fa-video text-primary"></i>
                      <div class="stat-number">{{ playlist|length }}</div>
                      <div class="stat-label">Видео</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="summary-stat">
                      <i class="fas fa-dumbbell text-success"></i>
                      <div class="stat-number">{% widthratio playlist|length 1 1.5|floatformat:0 %}</div>
                      <div class="stat-label">Упражнений</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="summary-stat">
                      <i class="fas fa-heart text-danger"></i>
                      <div class="stat-number">{% for item in playlist %}{% if item.role == 'Motivation' %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}</div>
                      <div class="stat-label">Мотивации</div>
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="alert alert-warning border-0 shadow-sm">
                <div class="d-flex align-items-center">
                  <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem; color: #f39c12;"></i>
                  <div>
                    <h5 class="alert-heading mb-1">Плейлист готовится</h5>
                    <p class="mb-0">Для этого дня ещё собирается индивидуальный видео-плейлист. Попробуйте через несколько минут.</p>
                  </div>
                </div>
              </div>
            {% endif %}

            <!-- Back to Plan Button -->
            <div class="text-center mt-5">
                <a href="{% url 'workouts:my_plan' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Вернуться к плану
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Modern minimalist base styles */
body {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: #1a202c;
}

.container-fluid {
    max-width: 1400px;
    margin: 0 auto;
}

.day-number-large {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 2.5rem;
    margin: 0 auto;
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

/* Modern clean container */
.modern-video-container {
    background: transparent;
    padding: 0;
    margin-bottom: 3rem;
}

/* Modern video player */
.modern-video-player {
    background: white;
    border-radius: 24px;
    padding: 0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(226, 232, 240, 0.5);
    overflow: hidden;
    margin-bottom: 2rem;
}

/* Video info header */
.video-info-header {
    padding: 1.5rem 2rem;
    background: white;
    border-bottom: 1px solid #f1f5f9;
    transition: opacity 0.3s ease;
}

.modern-controls {
    transition: opacity 0.3s ease;
}

.video-current-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.current-video-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1a202c;
    margin: 0;
    line-height: 1.3;
}

.video-progress-indicator {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.progress-text {
    font-size: 0.875rem;
    font-weight: 500;
    color: #64748b;
    white-space: nowrap;
}

.mini-progress-bar {
    width: 120px;
    height: 6px;
    background: #f1f5f9;
    border-radius: 3px;
    overflow: hidden;
}

.mini-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 3px;
    transition: width 0.3s ease;
    width: 0%;
}

/* Clean video container */
.video-container-modern {
    position: relative;
    background: #000;
    aspect-ratio: 16/9;
    border-radius: 16px;
    overflow: hidden;
}

.clean-video-player {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 16px;
    outline: none;
}

.clean-video-player:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

/* Modern start overlay */
.modern-start-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
    backdrop-filter: blur(20px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.4s ease;
    border-radius: 16px;
}

.start-content {
    text-align: center;
    color: white;
}

.start-icon-wrapper {
    position: relative;
    margin: 0 auto 2rem;
    width: 100px;
    height: 100px;
}

.start-icon-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
}

.start-icon {
    position: relative;
    z-index: 2;
    font-size: 2.5rem;
    margin-left: 4px;
    color: white;
    line-height: 100px;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 1; }
}

.start-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
    color: white;
}

.start-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0 0 2rem;
    font-weight: 400;
}

.modern-start-btn {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 1rem 2.5rem;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    cursor: pointer;
    text-transform: none;
}

.modern-start-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}


/* Modern controls */
.modern-controls {
    padding: 1.5rem 2rem;
    background: white;
    border-top: 1px solid #f1f5f9;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.controls-wrapper {
    display: flex;
    justify-content: center;
    gap: 1rem;
    align-items: center;
}

.modern-control-btn {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    border: none;
    background: #f8fafc;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    cursor: pointer;
    font-size: 1.1rem;
}

.modern-control-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.modern-control-btn.play-pause-btn {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
}

.modern-control-btn.play-pause-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.playlist-progress {
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-track {
    width: 100%;
    max-width: 400px;
    height: 8px;
    background: #f1f5f9;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
}

/* Modern playlist sidebar */
.playlist-sidebar {
    background: white;
    border-radius: 24px;
    border: 1px solid rgba(226, 232, 240, 0.5);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    max-height: 700px;
}

.playlist-sidebar-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.playlist-sidebar-header h5 {
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
}

.playlist-count {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.playlist-items {
    max-height: 550px;
    overflow-y: auto;
    padding: 0.5rem;
}

.playlist-sidebar-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin: 0.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 12px;
    position: relative;
    border: 1px solid transparent;
}

.playlist-sidebar-item:hover {
    background: #f8fafc;
    border-color: rgba(102, 126, 234, 0.2);
    transform: translateX(2px);
}

.playlist-sidebar-item.active {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    border-color: rgba(102, 126, 234, 0.3);
    transform: translateX(4px);
}

.playlist-sidebar-item.playing {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
    border-color: #667eea;
    transform: translateX(6px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.playlist-sidebar-item.completed {
    opacity: 0.8;
    background: rgba(34, 197, 94, 0.05);
    border-color: rgba(34, 197, 94, 0.2);
}

.playlist-sidebar-item.completed::after {
    content: '✓';
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #22c55e;
    font-weight: bold;
    font-size: 1.1rem;
    background: rgba(34, 197, 94, 0.1);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

.item-number {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    margin-right: 1rem;
    flex-shrink: 0;
}

.item-content {
    flex: 1;
    min-width: 0;
}

.item-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: #1e293b;
    margin-bottom: 0.375rem;
    line-height: 1.3;
}

.item-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
}

.item-role {
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-weight: 500;
    text-transform: capitalize;
    font-size: 0.7rem;
}

.item-role.motivation { background: #fef3c7; color: #d97706; }
.item-role.warmup { background: #dbeafe; color: #2563eb; }
.item-role.main { background: #d1fae5; color: #059669; }
.item-role.cooldown { background: #e9d5ff; color: #7c3aed; }

.item-duration {
    color: #64748b;
    font-weight: 500;
}

/* Modern summary styles */
.playlist-summary {
    background: white;
    border-radius: 24px;
    padding: 2rem;
    border: 1px solid rgba(226, 232, 240, 0.5);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}

.summary-stat {
    padding: 1.5rem 1rem;
    text-align: center;
}

.summary-stat i {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    display: block;
}

.stat-number {
    font-size: 2.25rem;
    font-weight: 700;
    color: #1e293b;
    line-height: 1;
    margin-bottom: 0.375rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Responsive design */
@media (max-width: 768px) {
    .day-number-large {
        width: 80px;
        height: 80px;
        font-size: 2rem;
    }
    
    .video-info-header {
        padding: 1rem;
    }
    
    .video-current-info {
        flex-direction: column;
        gap: 0.75rem;
        text-align: center;
    }
    
    .current-video-title {
        font-size: 1.1rem;
    }
    
    .start-title {
        font-size: 1.5rem;
    }
    
    .start-subtitle {
        font-size: 1rem;
    }
    
    .modern-start-btn {
        padding: 0.875rem 2rem;
        font-size: 1rem;
    }
    
    .playlist-sidebar {
        margin-top: 2rem;
        max-height: 400px;
    }
    
    .modern-controls {
        padding: 1rem;
    }
    
    .modern-control-btn {
        width: 44px;
        height: 44px;
        font-size: 1rem;
    }
    
    .modern-control-btn.play-pause-btn {
        width: 52px;
        height: 52px;
    }
    
    .playlist-summary {
        padding: 1.5rem;
    }
    
    .summary-stat {
        padding: 1rem 0.5rem;
    }
    
    .summary-stat i {
        font-size: 2rem;
    }
    
    .stat-number {
        font-size: 1.75rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Global playlist variables
let currentVideoIndex = 0;
let playlistStarted = false;
let playlistData = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize playlist data
    const playlistItems = document.querySelectorAll('.playlist-sidebar-item');
    playlistData = Array.from(playlistItems).map((item, index) => ({
        url: item.getAttribute('data-video-url'),
        title: item.getAttribute('data-video-title'),
        role: item.getAttribute('data-video-role'),
        index: index
    }));
    
    console.log('Playlist initialized with', playlistData.length, 'videos');
    
    // Setup playlist item clicks
    setupPlaylistInteractions();
    
    // Setup keyboard controls
    setupKeyboardControls();
});

// Start playlist function
function startPlaylist() {
    const video = document.getElementById('mainVideoPlayer');
    const startOverlay = document.getElementById('startOverlay');
    const videoInfoHeader = document.getElementById('videoInfoHeader');
    const modernControls = document.getElementById('modernControls');
    
    playlistStarted = true;
    
    // Hide start overlay with smooth animation
    startOverlay.style.opacity = '0';
    setTimeout(() => {
        startOverlay.style.display = 'none';
    }, 400);
    
    // Show video info and controls
    setTimeout(() => {
        videoInfoHeader.style.display = 'block';
        modernControls.style.display = 'flex';
        
        // Smooth fade in
        videoInfoHeader.style.opacity = '0';
        modernControls.style.opacity = '0';
        
        setTimeout(() => {
            videoInfoHeader.style.opacity = '1';
            modernControls.style.opacity = '1';
        }, 100);
    }, 200);
    
    // Start first video
    video.play();
    updateProgress();
    updatePlaylistStates();
    
    // Setup video event listeners
    setupVideoEvents();
    
    console.log('Modern playlist started');
}

// Setup video event listeners
function setupVideoEvents() {
    const video = document.getElementById('mainVideoPlayer');
    
    // Auto-advance to next video
    video.removeEventListener('ended', nextVideo); // Remove existing listener
    video.addEventListener('ended', function() {
        if (playlistStarted) {
            setTimeout(nextVideo, 500);
        }
    });
    
    // Update play/pause button
    video.addEventListener('play', function() {
        updatePlayPauseButton(false);
    });
    
    video.addEventListener('pause', function() {
        updatePlayPauseButton(true);
    });
    
    // Error handling
    video.addEventListener('error', function(e) {
        console.error('Video error:', e);
        showNotification('Ошибка загрузки видео', 'error');
    });
}

// Next video function
function nextVideo() {
    if (currentVideoIndex < playlistData.length - 1) {
        jumpToVideo(currentVideoIndex + 1);
    } else {
        completePlaylist();
    }
}

// Previous video function
function previousVideo() {
    if (currentVideoIndex > 0) {
        jumpToVideo(currentVideoIndex - 1);
    } else {
        showNotification('Это первое видео в плейлисте');
    }
}

// Jump to specific video
function jumpToVideo(index) {
    if (index < 0 || index >= playlistData.length || !playlistStarted) {
        if (!playlistStarted) {
            showNotification('Сначала нажмите "Начать тренировку"');
        }
        return;
    }
    
    const video = document.getElementById('mainVideoPlayer');
    const targetVideo = playlistData[index];
    
    currentVideoIndex = index;
    
    // Update video with fade effect
    video.style.opacity = '0.5';
    video.src = targetVideo.url;
    video.load();
    
    video.addEventListener('loadeddata', function() {
        video.style.opacity = '1';
        video.play();
        updateProgress();
        updateVideoInfo(targetVideo);
        updatePlaylistStates();
        
        showNotification(`Воспроизводится: ${targetVideo.title}`);
    }, { once: true });
}

// Toggle play/pause
function togglePlayPause() {
    const video = document.getElementById('mainVideoPlayer');
    
    if (!playlistStarted) {
        showNotification('Сначала нажмите "Начать тренировку"');
        return;
    }
    
    if (video.paused) {
        video.play();
    } else {
        video.pause();
    }
}

// Update progress indicators
function updateProgress() {
    if (!playlistStarted || playlistData.length === 0) return;
    
    const progressPercent = ((currentVideoIndex + 1) / playlistData.length) * 100;
    const playlistProgressBar = document.getElementById('playlistProgressBar');
    const miniProgressFill = document.getElementById('miniProgressFill');
    const currentVideoNumber = document.getElementById('currentVideoNumber');
    
    if (playlistProgressBar) {
        playlistProgressBar.style.width = progressPercent + '%';
    }
    
    if (miniProgressFill) {
        miniProgressFill.style.width = progressPercent + '%';
    }
    
    if (currentVideoNumber) {
        currentVideoNumber.textContent = currentVideoIndex + 1;
    }
}

// Update video info
function updateVideoInfo(video) {
    const currentVideoTitleHeader = document.getElementById('currentVideoTitleHeader');
    
    if (currentVideoTitleHeader) {
        currentVideoTitleHeader.textContent = video.title;
    }
}

// Update playlist visual states
function updatePlaylistStates() {
    const playlistItems = document.querySelectorAll('.playlist-sidebar-item');
    
    playlistItems.forEach((item, index) => {
        item.classList.remove('active', 'playing', 'completed');
        
        if (index === currentVideoIndex) {
            item.classList.add('playing');
        } else if (index < currentVideoIndex) {
            item.classList.add('completed');
        }
        
        // Smooth scroll to current item
        if (index === currentVideoIndex) {
            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    });
}

// Update play/pause button
function updatePlayPauseButton(isPaused) {
    const modernPlayPauseBtn = document.getElementById('modernPlayPauseBtn');
    if (modernPlayPauseBtn) {
        modernPlayPauseBtn.innerHTML = isPaused ? 
            '<i class="fas fa-play"></i>' : 
            '<i class="fas fa-pause"></i>';
        modernPlayPauseBtn.title = isPaused ? 'Воспроизведение' : 'Пауза';
    }
}

// Complete playlist
function completePlaylist() {
    const playlistProgressBar = document.getElementById('playlistProgressBar');
    const miniProgressFill = document.getElementById('miniProgressFill');
    
    if (playlistProgressBar) {
        playlistProgressBar.style.width = '100%';
    }
    
    if (miniProgressFill) {
        miniProgressFill.style.width = '100%';
    }
    
    updatePlaylistStates();
    showNotification('🎉 Все видео завершены! Отличная тренировка!');
    
    console.log('Modern playlist completed');
}

// Setup playlist interactions
function setupPlaylistInteractions() {
    const playlistItems = document.querySelectorAll('.playlist-sidebar-item');
    
    playlistItems.forEach((item, index) => {
        item.addEventListener('click', function() {
            jumpToVideo(index);
        });
    });
}

// Setup keyboard controls
function setupKeyboardControls() {
    document.addEventListener('keydown', function(e) {
        if (!playlistStarted) return;
        
        switch(e.key) {
            case 'ArrowRight':
            case 'n':
            case 'N':
                e.preventDefault();
                nextVideo();
                break;
            case 'ArrowLeft':
            case 'p':
            case 'P':
                e.preventDefault();
                previousVideo();
                break;
            case ' ':
                e.preventDefault();
                togglePlayPause();
                break;
        }
    });
}

// Show notification
function showNotification(message, type = 'info') {
    // Create or update notification
    let notification = document.getElementById('playlistNotification');
    
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'playlistNotification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? 'rgba(231, 76, 60, 0.95)' : 'rgba(78, 205, 196, 0.95)'};
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            z-index: 1000;
            font-weight: 600;
            transform: translateX(300px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 300px;
        `;
        document.body.appendChild(notification);
    }
    
    notification.textContent = message;
    notification.style.background = type === 'error' ? 
        'rgba(231, 76, 60, 0.95)' : 'rgba(78, 205, 196, 0.95)';
    
    // Show notification
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Hide notification after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(300px)';
        notification.style.opacity = '0';
    }, 3000);
}

// Debug logging
console.log('Modern playlist player initialized');
</script>
{% endblock %}